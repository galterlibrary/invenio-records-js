/*
 * This file is part of Invenio.
 * Copyright (C) 2016 CERN.
 *
 * Invenio is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of the
 * License, or (at your option) any later version.
 *
 * Invenio is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Invenio; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
 *
 * In applying this license, CERN does not
 * waive the privileges and immunities granted to it by virtue of its status
 * as an Intergovernmental Organization or submit itself to any jurisdiction.
 */
function invenioRecordsConfiguration(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}function invenioRecords(){function e(e,n,r){var o={templateParams:JSON.parse(r.templateParams||"{}")},i=JSON.parse(r.extraParams||"{}"),t=JSON.parse(r.links||"{}"),a=angular.merge({},o,i),s={form:r.form,initialization:r.initialization,schema:r.schema},c=JSON.parse(r.record||"{}");e.$broadcast("invenio.records.init",a,s,c,t)}return{restrict:"AE",scope:!1,controller:"InvenioRecordsCtrl",controllerAs:"recordsVM",link:e}}function invenioRecordsActions(){function e(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioRecords",templateUrl:e}}function invenioRecordsAlert(){function e(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioRecords",templateUrl:e}}function invenioRecordsForm(e,n,r,o){function i(i,t,a,s){function c(){var n=e.defer();return n.resolve({data:[]}),n.promise}function d(e,n){return void 0!==e.url?r.request(e).then(function(e){var r=m(e.data,n.resultSource);return angular.forEach(r,function(e,o){var i={};i[n.valueProperty]=m(e,n.valueSource||n.valueProperty),i[n.nameProperty]=m(e,n.nameSource||n.nameProperty),r[o]=i}),{data:r}},c):c()}function u(e,n,r){if(void 0!==n){var t={};angular.forEach(n,function(e,n){try{t[n]="value"===e?r:i.$eval(e)||e}catch(o){t[n]=e}}),e=e+"?"+o(angular.merge({},t))}return e}function l(n,r){var o={};if(""===r){if(i.lastSuggestions[n.url]){var t=e.defer();return t.resolve(i.lastSuggestions[n.url]),t.promise}if(n.scope&&"string"==typeof n.scope.insideModel)r=n.scope.insideModel,r=i.$eval(n.processQuery||"query",{query:r});else if(Array.isArray(n.initial)&&n.initial.length>0){var a=n.initial.map(function(e){return{name:"("+e.source+") "+e.value,value:e}}),c=e.defer();return c.resolve({data:a}),c.promise}}return r&&void 0!==n.url&&(o=angular.extend({},o,{url:u(n.url,n.urlParameters,r),method:"GET",data:n.data||{},headers:n.headers||s.invenioRecordsArgs.headers})),d(o,n.map).then(function(e){return i.lastSuggestions[n.url]=e,e})}if(a.formTemplates&&a.formTemplatesBase){var v=JSON.parse(a.formTemplates),f=a.formTemplatesBase;"/"!==f.substr(f.length-1)&&(f+="/"),angular.forEach(v,function(e,r){n.decorator()[r.replace("_","-")].template=f+e})}var m=function(e,n){return n.split(".").reduce(function(e,n){return e[n]},e)};i.lastSuggestions={},i.autocompleteSuggest=l}function t(e,n){return n.template}return{restrict:"AE",link:i,scope:!1,require:"^invenioRecords",templateUrl:t}}function invenioRecordsLoading(){function e(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioRecords",templateUrl:e}}function ChainedPromise(e){var n={};return n.promise=function(n){function r(e){e().then(function(e){return i.push(e),n.length>0?r(n.shift()):(o.resolve(i),void 0)},function(e){o.reject(e)})}var o=e.defer(),i=[];return r(n.shift()),o.promise},n}function InvenioRecordsCtrl(e,n,r,o,i,t,a){function s(e){b.invenioRecordsSchema=e.data}function c(e){b.invenioRecordsForm=e.data}function d(e,o,i,t,d){n.$broadcast("invenio.records.loading.start"),b.invenioRecordsModel=angular.copy(t),b.invenioRecordsArgs=angular.merge({},b.invenioRecordsArgs,o),b.invenioRecordsEndpoints=angular.merge({},i),Object.keys(d).length>0&&n.$broadcast("invenio.records.endpoints.updated",d),r.all([a.get(b.invenioRecordsEndpoints.schema).then(s),a.get(b.invenioRecordsEndpoints.form).then(c)]).then(function(){n.$broadcast("invenio.records.loading.stop")})}function u(){var e=r.defer();return angular.isUndefined(b.invenioRecordsEndpoints.self)?a.request({method:"POST",url:b.invenioRecordsEndpoints.initialization,data:{},headers:b.invenioRecordsArgs.headers||{}}).then(function(r){n.$broadcast("invenio.records.endpoints.updated",r.data.links),e.resolve({})},function(n){e.reject(n)}):e.resolve({}),e.promise}function l(){var e=angular.merge({},{metadata:b.invenioRecordsModel}),n=[[null],[{}],"",[void 0]];return angular.forEach(e.metadata,function(r,o){angular.forEach(n,function(n){angular.equals(n,r)&&delete e.metadata[o]})}),e}function v(e,n){var r=l();return a.request({url:b.invenioRecordsEndpoints[e],method:(n||"PUT").toUpperCase(),data:r,headers:b.invenioRecordsArgs.headers||{}})}function f(e){if(!angular.isUndefined(e)&&""!==e){var n=e;"/"!==e.substr(0,1)&&"http"!==e.substr(0,4)&&(n=b.invenioRecordsEndpoints[e]),o.location.href=n}}function m(o,i){function t(e){var r=e[e.length-1]||{};n.$broadcast("invenio.records.alert",{type:"success",data:r.data,action:s}),angular.isUndefined(r.data.links)||n.$broadcast("invenio.records.endpoints.updated",r.data.links),n.$broadcast("invenio.records.action.success",s),n.$broadcast("invenio.records.loading.stop"),f(i||void 0)}function a(o){if(n.$broadcast("invenio.records.alert",{type:"danger",data:o.data}),400===o.data.status&&o.data.errors){var i=r.defer(),t=i.promise;t.then(function(){angular.forEach(o.data.errors,function(n){try{e.$broadcast("schemaForm.error."+n.field.replace("metadata.",""),"backendValidationError",n.message)}catch(r){e.$broadcast("schemaForm.error."+n.field,"backendValidationError",n.message)}})}).then(function(){n.$broadcast("invenio.records.loading.stop")}),i.resolve()}else n.$broadcast("invenio.records.loading.stop");n.$broadcast("invenio.records.action.error",o.data)}var s="string"==typeof o[0]?[o]:o;n.$broadcast("invenio.records.loading.start"),u().then(function(){var e=[];angular.forEach(s,function(e){this.push(v(e[0],e[1]))},e),r.all(e).then(t,a)},a)}function p(n,r){r.validationMessage&&e.$broadcast("schemaForm.error."+r.key.join("."),"backendValidationError",!0)}function g(){b.invenioRecordsLoading=!0}function R(){b.invenioRecordsLoading=!1}function h(e,n){b.invenioRecordsAlert=null,t(function(){b.invenioRecordsAlert=n},0)}function $(n,r){var o=[];angular.forEach(r,function(e){this.push(e[0])},o),o.indexOf("self")>-1?e.depositionForm.$setPristine():o.indexOf("publish")>-1&&(e.depositionForm.$setPristine(),e.depositionForm.$setSubmitted())}function E(e,r){b.invenioRecordsEndpoints=angular.merge({},b.invenioRecordsEndpoints,r),n.$broadcast("invenio.records.location.updated",r)}function A(e,n){if(!angular.isUndefined(n.html)){var r=document.createElement("a");r.href=n.html,i.url(r.pathname),i.replace()}}var b=this;b.invenioRecordsArgs={url:"/",method:"GET",headers:{"Content-Type":"application/json"}},b.invenioRecordsModel=null,b.invenioRecordsEndpoints=null,b.invenioRecordsLoading=!0,b.invenioRecordsAlert=null,b.actionHandler=m,b.removeValidationMessage=p,e.$on("invenio.records.init",d),n.$on("invenio.records.alert",h),n.$on("invenio.records.loading.start",g),n.$on("invenio.records.loading.stop",R),n.$on("invenio.records.action.success",$),n.$on("invenio.records.endpoints.updated",E),n.$on("invenio.records.location.updated",A)}function InvenioRecordsAPI(e,n){function r(n){return e(n)}function o(e){if(null===e){var o=n.defer();return o.resolve(),o.promise}var i={url:e,method:"GET"};return r(i)}return{get:o,request:r}}angular.module("invenioRecords.config",[]),angular.module("invenioRecords.controllers",[]),angular.module("invenioRecords.directives",[]),angular.module("invenioRecords.factories",[]),angular.module("invenioRecords.services",[]),angular.module("invenioRecords",["schemaForm","invenioRecords.config","invenioRecords.factories","invenioRecords.services","invenioRecords.controllers","invenioRecords.directives"]),invenioRecordsConfiguration.$inject=["$locationProvider"],angular.module("invenioRecords.config").config(invenioRecordsConfiguration),angular.module("invenioRecords.directives").directive("invenioRecords",invenioRecords),angular.module("invenioRecords.directives").directive("invenioRecordsActions",invenioRecordsActions),angular.module("invenioRecords.directives").directive("invenioRecordsAlert",invenioRecordsAlert),invenioRecordsForm.$inject=["$q","schemaFormDecorators","InvenioRecordsAPI","$httpParamSerializerJQLike"],angular.module("invenioRecords.directives").directive("invenioRecordsForm",invenioRecordsForm),angular.module("invenioRecords.directives").directive("invenioRecordsLoading",invenioRecordsLoading),ChainedPromise.$inject=["$q"],angular.module("invenioRecords.factories").factory("ChainedPromise",ChainedPromise),InvenioRecordsCtrl.$inject=["$scope","$rootScope","$q","$window","$location","$timeout","InvenioRecordsAPI"],angular.module("invenioRecords.controllers").controller("InvenioRecordsCtrl",InvenioRecordsCtrl),InvenioRecordsAPI.$inject=["$http","$q"],angular.module("invenioRecords.services").service("InvenioRecordsAPI",InvenioRecordsAPI);