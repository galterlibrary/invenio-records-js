/*
 * This file is part of Invenio.
 * Copyright (C) 2016 CERN.
 *
 * Invenio is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as
 * published by the Free Software Foundation; either version 2 of the
 * License, or (at your option) any later version.
 *
 * Invenio is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Invenio; if not, write to the Free Software Foundation, Inc.,
 * 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
 *
 * In applying this license, CERN does not
 * waive the privileges and immunities granted to it by virtue of its status
 * as an Intergovernmental Organization or submit itself to any jurisdiction.
 */
function invenioRecordsConfiguration(e){e.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}function InvenioRecordsCtrl(e,n,r,o,i,t,a,s){function c(e){q.invenioRecordsSchema=e.data}function d(e){q.invenioRecordsForm=e.data}function u(e,o,i,t,s){n.$broadcast("invenio.records.loading.start"),q.invenioRecordsModel=angular.copy(t),q.invenioRecordsEndpoints=angular.merge({},i),q.invenioRecordsArgs=angular.merge({},q.invenioRecordsArgs,o),Object.keys(s).length>0&&n.$broadcast("invenio.records.endpoints.updated",s),r.all([a.get(q.invenioRecordsEndpoints.schema).then(c),a.get(q.invenioRecordsEndpoints.form).then(d)]).then(function(){n.$broadcast("invenio.records.loading.stop")})}function l(){var e=r.defer();if(angular.isUndefined(q.invenioRecordsEndpoints.self)){var o=a.prepareRequest(q.invenioRecordsEndpoints.initialization,"POST",{},q.invenioRecordsArgs,q.invenioRecordsEndpoints);a.request(o).then(function(r){n.$broadcast("invenio.records.endpoints.updated",r.data.links),e.resolve({})},function(n){e.reject(n)})}else e.resolve({});return e.promise}function v(e,n){function r(){return m(e,n)}return r}function f(){var e=angular.merge({},{metadata:q.invenioRecordsModel}),n=[[null],[{}],"",[void 0]];return angular.forEach(e.metadata,function(r,o){angular.forEach(n,function(n){angular.equals(n,r)&&delete e.metadata[o]})}),e}function m(e,n){var r=f(),o=a.prepareRequest(q.invenioRecordsEndpoints[e],n,r,q.invenioRecordsArgs,q.invenioRecordsEndpoints);return a.request(o)}function p(e){if(!angular.isUndefined(e)&&""!==e){var n=e;"/"!==e.substr(0,1)&&"http"!==e.substr(0,4)&&(n=q.invenioRecordsEndpoints[e]),o.location.href=n}}function g(o,i){function t(e){var r=e[e.length-1]||e;n.$broadcast("invenio.records.alert",{type:"success",data:r.data,action:c}),angular.isUndefined(r.data.links)||n.$broadcast("invenio.records.endpoints.updated",r.data.links),n.$broadcast("invenio.records.action.success",c),n.$broadcast("invenio.records.loading.stop"),p(i||void 0)}function a(o){var i=o[o.length-1]||o;if(n.$broadcast("invenio.records.alert",{type:"danger",data:i.data}),400===i.data.status&&i.data.errors){var t=r.defer(),a=t.promise;a.then(function(){angular.forEach(i.data.errors,function(n){e.$broadcast("schemaForm.error."+n.field,"backendValidationError",n.message)})}).then(function(){n.$broadcast("invenio.records.loading.stop")}),t.resolve()}else n.$broadcast("invenio.records.loading.stop");n.$broadcast("invenio.records.action.error",i.data)}var c="string"==typeof o[0]?[o]:o;n.$broadcast("invenio.records.loading.start"),l().then(function(){var e=[];angular.forEach(c,function(e){this.push(v(e[0],e[1]))},e),s.promise(e).then(t,a)},a)}function R(n,r){r.validationMessage&&e.$broadcast("schemaForm.error."+r.key.join("."),"backendValidationError",!0)}function h(){q.invenioRecordsLoading=!0}function $(){q.invenioRecordsLoading=!1}function E(e,n){q.invenioRecordsAlert=null,t(function(){q.invenioRecordsAlert=n},0)}function A(n,r){var o=[];angular.forEach(r,function(e){this.push(e[0])},o),o.indexOf("self")>-1?e.depositionForm.$setPristine():o.indexOf("publish")>-1&&(e.depositionForm.$setPristine(),e.depositionForm.$setSubmitted())}function b(e,r){q.invenioRecordsEndpoints=angular.merge({},q.invenioRecordsEndpoints,r),n.$broadcast("invenio.records.location.updated",r)}function P(e,n){if(!angular.isUndefined(n.html)){var r=document.createElement("a");r.href=i.path();var o=document.createElement("a");o.href=n.html,o.pathname!==r.pathname&&(i.url(o.pathname),i.replace())}}var q=this;q.invenioRecordsArgs={url:"/",method:"GET",headers:{"Content-Type":"application/json"}},q.invenioRecordsModel=null,q.invenioRecordsEndpoints=null,q.invenioRecordsLoading=!0,q.invenioRecordsAlert=null,q.actionHandler=g,q.removeValidationMessage=R,e.$on("invenio.records.init",u),n.$on("invenio.records.alert",E),n.$on("invenio.records.loading.start",h),n.$on("invenio.records.loading.stop",$),n.$on("invenio.records.action.success",A),n.$on("invenio.records.endpoints.updated",b),n.$on("invenio.records.location.updated",P)}function ChainedPromise(e){var n={};return n.promise=function(n){function r(e){e().then(function(e){return i.push(e),n.length>0?r(n.shift()):(o.resolve(i),void 0)},function(e){o.reject(e)})}var o=e.defer(),i=[];return r(n.shift()),o.promise},n}function invenioRecords(){function e(e,n,r){var o={templateParams:JSON.parse(r.templateParams||"{}")},i=JSON.parse(r.extraParams||"{}"),t=JSON.parse(r.links||"{}"),a=angular.merge({},o,i),s={form:r.form,initialization:r.initialization,schema:r.schema},c=JSON.parse(r.record||"{}");e.$broadcast("invenio.records.init",a,s,c,t)}return{restrict:"AE",scope:!1,controller:"InvenioRecordsCtrl",controllerAs:"recordsVM",link:e}}function invenioRecordsActions(){function e(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioRecords",templateUrl:e}}function invenioRecordsAlert(){function e(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioRecords",templateUrl:e}}function invenioRecordsForm(e,n,r,o){function i(i,t,a,s){function c(){var n=e.defer();return n.resolve({data:[]}),n.promise}function d(e,n){return void 0!==e.url?r.request(e).then(function(e){var r=p(e.data,n.resultSource);return angular.forEach(r,function(e,o){var i={};i[n.valueProperty]=p(e,n.valueSource||n.valueProperty),i[n.nameProperty]=p(e,n.nameSource||n.nameProperty),r[o]=i}),{data:r}},c):c()}function u(e,n,r){if(void 0!==n){var t={};angular.forEach(n,function(e,n){try{t[n]="value"===e?r:i.$eval(e)||e}catch(o){t[n]=e}}),e=e+"?"+o(angular.merge({},t))}return e}function l(n,r){var o={};if(""===r){if(i.lastSuggestions[n.url]){var t=e.defer();return t.resolve(i.lastSuggestions[n.url]),t.promise}n.scope&&"string"==typeof n.scope.insideModel&&(r=n.scope.insideModel,r=i.$eval(n.processQuery||"query",{query:r}))}return r&&void 0!==n.url&&(o=angular.extend({},o,{url:u(n.url,n.urlParameters,r),method:"GET",data:n.data||{},headers:n.headers||s.invenioRecordsArgs.headers})),d(o,n.map).then(function(e){return i.lastSuggestions[n.url]=e,e})}function v(n,r){var o=""===r||r===n.scope.insideModel;if(o&&n.scope.insideModel){var i=n.scope.insideModel,t=[{name:"("+i.source+") "+i.value,value:i}],a=e.defer();return a.resolve({data:t}),a.promise}return l(n,r)}if(a.formTemplates&&a.formTemplatesBase){var f=JSON.parse(a.formTemplates),m=a.formTemplatesBase;"/"!==m.substr(m.length-1)&&(m+="/"),angular.forEach(f,function(e,r){n.decorator()[r.replace("_","-")].template=m+e})}var p=function(e,n){return n.split(".").reduce(function(e,n){return e[n]},e)};i.lastSuggestions={},i.autocompleteSuggest=l,i.autocompleteTerms=v}function t(e,n){return n.template}return{restrict:"AE",link:i,scope:!1,require:"^invenioRecords",templateUrl:t}}function invenioRecordsLoading(){function e(e,n){return n.template}return{restrict:"AE",scope:!1,require:"^invenioRecords",templateUrl:e}}function InvenioRecordsAPI(e,n){function r(n){return e(n)}function o(e){if(null===e){var o=n.defer();return o.resolve(),o.promise}var i={url:e,method:"GET"};return r(i)}function i(e,n){var r=n||[[null],[{}],"",[void 0]];return angular.forEach(e,function(n,o){angular.forEach(r,function(r){angular.equals(r,n)&&delete e[o]})}),e}function t(e,n,r){var o=angular.merge({},n.data||{},i(e));return void 0===o.$schema&&void 0!==r.schema&&(o.$schema=r.schema),o}function a(e,n,r,o,i){var a={url:e,method:n,headers:o.headers||{},data:t(r,o,i)};return a}return{cleanData:i,get:o,getData:t,prepareRequest:a,request:r}}angular.module("invenioRecords.config",[]),angular.module("invenioRecords.controllers",[]),angular.module("invenioRecords.directives",[]),angular.module("invenioRecords.factories",[]),angular.module("invenioRecords.services",[]),angular.module("invenioRecords",["schemaForm","invenioRecords.config","invenioRecords.factories","invenioRecords.services","invenioRecords.controllers","invenioRecords.directives"]),invenioRecordsConfiguration.$inject=["$locationProvider"],angular.module("invenioRecords.config").config(invenioRecordsConfiguration),InvenioRecordsCtrl.$inject=["$scope","$rootScope","$q","$window","$location","$timeout","InvenioRecordsAPI","ChainedPromise"],angular.module("invenioRecords.controllers").controller("InvenioRecordsCtrl",InvenioRecordsCtrl),ChainedPromise.$inject=["$q"],angular.module("invenioRecords.factories").factory("ChainedPromise",ChainedPromise),angular.module("invenioRecords.directives").directive("invenioRecords",invenioRecords),angular.module("invenioRecords.directives").directive("invenioRecordsActions",invenioRecordsActions),angular.module("invenioRecords.directives").directive("invenioRecordsAlert",invenioRecordsAlert),invenioRecordsForm.$inject=["$q","schemaFormDecorators","InvenioRecordsAPI","$httpParamSerializerJQLike"],angular.module("invenioRecords.directives").directive("invenioRecordsForm",invenioRecordsForm),angular.module("invenioRecords.directives").directive("invenioRecordsLoading",invenioRecordsLoading),InvenioRecordsAPI.$inject=["$http","$q"],angular.module("invenioRecords.services").service("InvenioRecordsAPI",InvenioRecordsAPI);